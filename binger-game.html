<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†°å„¿çš„å¿ƒåŠ¨ä¹‹æ—…</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Custom scrollbar for output area */
        #output::-webkit-scrollbar {
            width: 8px;
        }
        #output::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #output::-webkit-scrollbar-thumb {
            background: #eab308; /* Tailwind yellow-500 */
            border-radius: 10px;
        }
        #output::-webkit-scrollbar-thumb:hover {
            background: #d97706; /* Tailwind amber-600 */
        }
    </style>
</head>
<body>
    <div id="game-container" class="flex flex-col items-center justify-center p-4">
        <div id="game-area" class="w-full max-w-xl bg-white p-6 rounded-xl shadow-2xl border-4 border-yellow-400">
            <h1 class="text-3xl font-extrabold text-center mb-6 text-pink-600">ğŸ’– å†°å„¿çš„å¿ƒåŠ¨ä¹‹æ—… ğŸ’–</h1>

            <div id="output" class="bg-gradient-to-br from-purple-50 to-pink-50 p-5 rounded-lg shadow-inner mb-6 text-gray-800 text-base leading-relaxed h-52 overflow-y-auto border border-purple-200">
                <!-- æ¸¸æˆæ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>

            <div id="menu" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                <!-- äº’åŠ¨é€‰é¡¹æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="flex flex-col gap-3">
                <input type="text" id="user-input"
                       class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-yellow-300 transition-all text-gray-700 placeholder-gray-400"
                       placeholder="äº²çˆ±çš„ç©å®¶,ä½ æƒ³å¯¹å†°å„¿åšä»€ä¹ˆå‘¢?è¾“å…¥é€‰é¡¹æ•°å­—æˆ–æŒ‰å›è½¦ç»§ç»­..." disabled>
                <button id="submit-button"
                        class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-600 transition-transform transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-yellow-300">
                    ç¡®è®¤
                </button>
                <button id="restart-button"
                        class="bg-pink-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-pink-600 transition-transform transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-pink-300 hidden">
                    é‡æ–°å¼€å§‹
                </button>
            </div>

            <div id="status" class="mt-6 text-center text-gray-700 text-lg font-semibold">
                <!-- å¿ƒåŠ¨å€¼å’Œäº¤æµæ¬¡æ•°å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK å¯¼å…¥
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // è·å– DOM å…ƒç´ 
        const outputDiv = document.getElementById('output');
        const menuDiv = document.getElementById('menu');
        const userInput = document.getElementById('user-input');
        const submitButton = document.getElementById('submit-button');
        const statusDiv = document.getElementById('status');
        const restartButton = document.getElementById('restart-button');

        // æ¸¸æˆçŠ¶æ€å˜é‡
        let heartValue = 50;
        let interactionCount = 0;
        let gameActive = false;
        let introMessageIndex = 0; // æ–°å¢ï¼šè·Ÿè¸ªä»‹ç»æ¶ˆæ¯çš„ç´¢å¼•
        let introMessagesCompleted = false; // æ–°å¢ï¼šæ ‡è®°ä»‹ç»æ˜¯å¦å®Œæˆ

        // Firebase å˜é‡
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // é»˜è®¤åŒ¿åç”¨æˆ·ID

        // ä» Canvas ç¯å¢ƒä¸­è·å–å…¨å±€å˜é‡
        // æ³¨æ„ï¼šåœ¨éƒ¨ç½²åˆ° GitHub Pages ç­‰ç¯å¢ƒæ—¶ï¼Œè¿™äº›å˜é‡éœ€è¦è¢«å®é™…çš„ Firebase é…ç½®å€¼æ›¿æ¢
        // ä½†åœ¨ Google Labs ç¯å¢ƒä¸­ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨æä¾›
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // äº’åŠ¨é€‰é¡¹åˆ—è¡¨
        const interactionOptions = [
            'æ¸©æŸ”èµç¾', 'æš´åŠ›æŠ½æŸ¥', 'éœ¸é“å¼ºå»', 'æŠšæ‘¸å¤§è…¿', 'éœ¸é“æ‹¥æŠ±',
            'é€ä¸€æŸç«ç‘°', 'å¤šå–çƒ­æ°´', 'èˆ”èˆç‰è¶³', 'å®å¸å°å­¦', 'è¹‚èºç¾ä¹³'
        ];

        const introMessages = [
            "äº²çˆ±çš„ç©å®¶ä½ å¥½,æ¬¢è¿æ¥åˆ°å†°å„¿çš„å¿ƒåŠ¨ä¹‹æ—…!",
            "ä¸€å¼€å§‹å†°å„¿å¯¹ä½ çš„å¿ƒåŠ¨å€¼æœ‰50ç‚¹,ä½ å¯ä»¥é€šè¿‡å’Œå¥¹è¿›è¡Œä¸åŒçš„äº¤æµæ¥è·å¾—å¿ƒåŠ¨å€¼å“¦ã€‚",
            "ä¸è¿‡å°å¿ƒ,å¦‚æœé‡‡ç”¨äº†é”™è¯¯çš„æ–¹å¼,å†°å„¿çš„å¿ƒåŠ¨å€¼ä¼šä¸‹é™å“¦ã€‚",
            "ä¸­é€”ä¸­ä½ å¯ä»¥éšæ—¶ç»“æŸ,å†°å„¿çš„å¿ƒåŠ¨å€¼ä½äº0æˆ–è€…é«˜äº100ä¹Ÿä¼šè¢«åŠ¨ç»“æŸå“¦ã€‚",
            "ç»“æŸåä¼šç»™å‡ºä½ çš„äº¤æµæ¬¡æ•°å’Œå¾—åˆ†å“¦,è®©æˆ‘ä»¬å¼€å§‹å§!"
        ];

        /**
         * å‘æ¸¸æˆè¾“å‡ºåŒºåŸŸæ·»åŠ æ¶ˆæ¯
         * @param {string} message è¦æ·»åŠ çš„æ¶ˆæ¯
         */
        function appendMessage(message) {
            const p = document.createElement('p');
            p.textContent = message;
            outputDiv.appendChild(p);
            outputDiv.scrollTop = outputDiv.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
        }

        /**
         * æ›´æ–°å¿ƒåŠ¨å€¼æ˜¾ç¤º
         */
        function updateStatus() {
            statusDiv.textContent = `å†°å„¿å¯¹ä½ çš„å¿ƒåŠ¨å€¼ä¸º: ${heartValue.toFixed(1)} â¤ï¸ | äº¤æµæ¬¡æ•°: ${interactionCount} ğŸ’¬`;
        }

        /**
         * æ ¹æ®å¿ƒåŠ¨å€¼å˜åŒ–è¿”å›å†°å„¿çš„å¿ƒæƒ…å›åº”
         * @param {number} change å¿ƒåŠ¨å€¼å˜åŒ–é‡
         * @returns {string} å¿ƒæƒ…å›åº”
         */
        function getMoodResponse(change) {
            if (change < -5) {
                return "å†°å„¿æ°”ç‚¸äº†ï¼(â•¯Â°â–¡Â°)â•¯ï¸µ â”»â”â”»";
            } else if (change < -4) {
                return "å†°å„¿è¶…çº§æ„¤æ€’ï¼ä¸æƒ³å’Œä½ è¯´è¯ï¼";
            } else if (change < -3) {
                return "å†°å„¿éå¸¸ç”Ÿæ°”ï¼è¡¨ç¤ºä¸æƒ³ç†ä½ ï¼";
            } else if (change < -2) {
                return "å†°å„¿æœ‰ç‚¹ç”Ÿæ°”ï¼Œå“¼ï¼";
            } else if (change < -1) {
                return "å†°å„¿ä¸å¤ªé«˜å…´...ï¼ˆæ’‡å˜´ï¼‰";
            } else if (change < 0) {
                return "å†°å„¿å¾®å¾®çš±çœ‰ï¼Œæœ‰ç‚¹å°æƒ…ç»ª~";
            } else if (change === 0) {
                return "å†°å„¿é¢æ— è¡¨æƒ…ï¼Œæ¯«æ— æ³¢æ¾œã€‚";
            } else if (change <= 1) {
                return "å†°å„¿å¾®å¾®ä¸€ç¬‘ï¼Œå¿ƒæƒ…è¿˜è¡Œ~";
            } else if (change <= 2) {
                return "å†°å„¿æŒºå¼€å¿ƒçš„ï¼Œå¯¹ä½ ç¬‘äº†ç¬‘ï¼";
            } else if (change <= 3) {
                return "å†°å„¿éå¸¸å¼€å¿ƒï¼çœ¼ç›å¼¯æˆæœˆç‰™~";
            } else if (change <= 4) {
                return "å†°å„¿è¶…çº§é«˜å…´ï¼ä¸»åŠ¨æ‰¾ä½ èŠå¤©ï¼";
            } else if (change <= 5) {
                return "å†°å„¿ä¹ç–¯äº†ï¼(â‰§â–½â‰¦) è¶…çº§å–œæ¬¢ä½ ï¼";
            } else {
                return "å†°å„¿å¼€å¿ƒåˆ°é£èµ·ï¼å®‡å®™çº§å¿«ä¹ï¼âœ¨";
            }
        }

        /**
         * æ›´æ–°å¿ƒåŠ¨å€¼é€»è¾‘ (æ ¹æ®åŸå§‹ Python ä»£ç è½¬æ¢)
         * @param {number} current_value å½“å‰å¿ƒåŠ¨å€¼
         * @param {number} choice_id é€‰é¡¹ ID (1-10)
         * @returns {number} æ›´æ–°åçš„å¿ƒåŠ¨å€¼
         */
        function updateHeartValue(current_value, choice_id) {
            let newValue = current_value;
            if (choice_id === 1) { // æ¸©æŸ”èµç¾
                if (newValue < 80) {
                    newValue += 1;
                } else {
                    newValue -= 2;
                }
            } else if (choice_id === 2) { // æš´åŠ›æŠ½æŸ¥
                newValue = newValue + Math.floor(newValue / 5) - 13;
            } else if (choice_id === 3) { // éœ¸é“å¼ºå»
                newValue = newValue + Math.floor((Math.floor(newValue / 5) - 13) / 2);
            } else if (choice_id === 4) { // æŠšæ‘¸å¤§è…¿
                if (newValue < 60) {
                    newValue += 2;
                } else {
                    newValue -= 1;
                }
            } else if (choice_id === 5) { // éœ¸é“æ‹¥æŠ±
                if (newValue < 70) {
                    newValue += 1.5;
                }
            } else if (choice_id === 6) { // é€ä¸€æŸç«ç‘°
                newValue = newValue + 12 - Math.floor(newValue / 5);
            } else if (choice_id === 7) { // å¤šå–çƒ­æ°´
                if (newValue < 65) {
                    newValue -= 2;
                } else {
                    newValue += 1.5;
                }
            } else if (choice_id === 8) { // èˆ”èˆç‰è¶³
                if (newValue < 80) {
                    newValue -= 2;
                } else if (newValue < 90) {
                    newValue += 3.5;
                } else {
                    newValue -= 1.5;
                }
            } else if (choice_id === 9) { // å®å¸å°å­¦
                if (newValue > 90) {
                    newValue += 6;
                } else {
                    newValue += 0.5;
                }
            } else if (choice_id === 10) { // è¹‚èºç¾ä¹³
                if (newValue > 75) {
                    newValue += 2;
                } else {
                    newValue += 0.5;
                }
            }
            return newValue;
        }

        /**
         * ä¿å­˜æ¸¸æˆå¾—åˆ†åˆ° Firestore
         * @param {number} finalScore æœ€ç»ˆå¾—åˆ†
         * @param {number} finalHeartValue æœ€ç»ˆå¿ƒåŠ¨å€¼
         * @param {number} totalInteractions æ€»äº¤æµæ¬¡æ•°
         */
        async function saveScore(finalScore, finalHeartValue, totalInteractions) {
            // åœ¨éƒ¨ç½²åˆ° GitHub Pages ç­‰ç¯å¢ƒæ—¶ï¼Œè¿™é‡Œçš„ __app_id, __firebase_config, __initial_auth_token éœ€è¦æ›¿æ¢ä¸ºå®é™…å€¼
            // åœ¨ Google Labs ç¯å¢ƒä¸­ï¼Œè¿™äº›å˜é‡ä¼šè‡ªåŠ¨æä¾›
            if (!db || !userId || userId === 'anonymous') {
                appendMessage("æ— æ³•è·å–ç”¨æˆ·IDæˆ–Firestoreæœªå‡†å¤‡å¥½ã€‚è¯·ç¡®ä¿ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢ã€‚");
                return;
            }
            try {
                // æ ¹æ® Firestore å®‰å…¨è§„åˆ™ï¼Œå­˜å‚¨åˆ°ç”¨æˆ·ç§æœ‰æ•°æ®è·¯å¾„
                const scoresCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/game_scores`);
                await addDoc(scoresCollectionRef, {
                    score: finalScore,
                    finalHeartValue: finalHeartValue,
                    interactionsCount: totalInteractions,
                    timestamp: serverTimestamp() // ä½¿ç”¨ Firestore æœåŠ¡å™¨æ—¶é—´æˆ³
                });
                appendMessage("å¾—åˆ†å·²æˆåŠŸä¿å­˜ï¼");
            } catch (e) {
                console.error("ä¿å­˜å¾—åˆ†æ—¶å‡ºé”™: ", e);
                appendMessage("ä¿å­˜å¾—åˆ†å¤±è´¥ã€‚");
            }
        }

        /**
         * æ˜¾ç¤ºäº’åŠ¨èœå•æŒ‰é’®
         */
        function displayInteractionOptions() {
            menuDiv.innerHTML = ''; // æ¸…ç©ºæ—§æŒ‰é’®
            interactionOptions.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = `${index + 1}. ${option}`;
                button.className = 'bg-blue-500 text-white p-3 rounded-lg shadow-md hover:bg-blue-600 transition-colors transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm md:text-base';
                button.onclick = () => handleChoice(index + 1); // ä¼ å…¥ choice_id (1-10)
                menuDiv.appendChild(button);
            });
            userInput.placeholder = "è¯·è¾“å…¥ä½ çš„é€‰é¡¹æ•°å­—:";
            userInput.disabled = false;
        }

        /**
         * å¤„ç†ç”¨æˆ·é€‰æ‹©
         * @param {number} choiceId ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹ ID
         */
        function handleChoice(choiceId) {
            if (!gameActive) return; // ç¡®ä¿æ¸¸æˆå¤„äºæ´»è·ƒçŠ¶æ€æ‰å¤„ç†é€‰æ‹©

            const actionDescription = interactionOptions[choiceId - 1];
            const oldHeart = heartValue;
            heartValue = updateHeartValue(oldHeart, choiceId);
            const deltaHeart = heartValue - oldHeart;
            const moodResponse = getMoodResponse(deltaHeart);

            interactionCount++;

            appendMessage(`ä½ å¯¹å†°å„¿${actionDescription}`);
            appendMessage(`å†°å„¿çš„å¿ƒåŠ¨å€¼å˜åŒ–äº†${deltaHeart.toFixed(1)}ï¼Œ${moodResponse}`);
            updateStatus();

            if (heartValue < 0 || heartValue > 100) {
                endGame();
            } else {
                appendMessage(`ä½ ç°åœ¨å·²ç»å’Œå†°å„¿äº¤æµ${interactionCount}æ¬¡äº†.`);
                // å†æ¬¡æ˜¾ç¤ºé€‰é¡¹ï¼Œç¡®ä¿ç”¨æˆ·å¯ä»¥ç»§ç»­é€‰æ‹©æˆ–é€€å‡º
                appendMessage('æ˜¯å¦ç»§ç»­é™ªå†°å„¿ç©è€? æƒ³è¦çš„è¯è¾“å…¥é€‰é¡¹æ•°å­—ï¼Œé€€å‡ºæ¸¸æˆè¯·è¾“å…¥ "å¦"');
                userInput.placeholder = "è¯·è¾“å…¥é€‰é¡¹æ•°å­—æˆ–'å¦'é€€å‡º";
            }
            userInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        }

        /**
         * å¤„ç†ç”¨æˆ·è¾“å…¥ (åŒ…æ‹¬æŒ‰å›è½¦ç»§ç»­å’Œé€‰æ‹©é€‰é¡¹)
         */
        async function handleUserInputEvent() {
            const input = userInput.value.trim();
            userInput.value = ''; // ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†

            if (!gameActive) { // å¦‚æœæ¸¸æˆæœªæ¿€æ´»ï¼Œè¯´æ˜è¿˜åœ¨ä»‹ç»é˜¶æ®µ
                handleIntroContinue();
                return;
            }

            // æ¸¸æˆå·²æ¿€æ´»ï¼Œå¤„ç†æ¸¸æˆä¸­çš„è¾“å…¥
            if (input === 'å¦') {
                endGame(true); // ç”¨æˆ·ä¸»åŠ¨é€€å‡º
                return;
            }

            // å°è¯•å°†è¾“å…¥è§£æä¸ºæ•°å­—é€‰é¡¹
            if (input.match(/^\d+$/)) {
                const choiceId = parseInt(input, 10);
                if (choiceId >= 1 && choiceId <= interactionOptions.length) {
                    handleChoice(choiceId);
                } else {
                    appendMessage('è¯·è¾“å…¥å¯é€‰æ‹©èŒƒå›´å†…çš„æ•°å­—å“¦ã€‚');
                }
            } else {
                appendMessage('è¯·è¾“å…¥æ•°å­—å“¦ã€‚');
            }
        }

        /**
         * å¤„ç†ä»‹ç»æ¶ˆæ¯çš„ç»§ç»­é€»è¾‘
         */
        function handleIntroContinue() {
            if (introMessageIndex < introMessages.length) {
                appendMessage(introMessages[introMessageIndex]);
                userInput.placeholder = "è¯·æŒ‰å›è½¦ç»§ç»­...";
                userInput.disabled = false;
                introMessageIndex++;
            } else {
                // æ‰€æœ‰ä»‹ç»æ¶ˆæ¯æ˜¾ç¤ºå®Œæ¯•
                introMessagesCompleted = true;
                gameActive = true; // æ¸¸æˆæ­£å¼å¼€å§‹
                displayInteractionOptions(); // æ˜¾ç¤ºäº’åŠ¨é€‰é¡¹æŒ‰é’®
                userInput.placeholder = "è¯·è¾“å…¥ä½ çš„é€‰é¡¹æ•°å­—:";
                userInput.disabled = false;
            }
        }

        /**
         * ç»“æŸæ¸¸æˆ
         * @param {boolean} userExited æ˜¯å¦ç”¨æˆ·ä¸»åŠ¨é€€å‡º
         */
        async function endGame(userExited = false) {
            gameActive = false;
            userInput.disabled = true;
            menuDiv.innerHTML = ''; // æ¸…ç©ºé€‰é¡¹æŒ‰é’®
            submitButton.disabled = true; // ç¦ç”¨ç¡®è®¤æŒ‰é’®
            restartButton.classList.remove('hidden'); // æ˜¾ç¤ºé‡æ–°å¼€å§‹æŒ‰é’®

            let finalScore = 0;
            let finalMessage = '';

            // åŸå§‹ Python é€»è¾‘
            // score = int((heart**2 / 50) * (1 if heart >= 0 else -1) - (i**0.5 * 10))
            if (heartValue < 0) {
                finalScore = Math.floor((heartValue * heartValue / 50) * -1 - (interactionCount ** 0.5 * 10));
                finalMessage = `æ¸¸æˆç»“æŸ,å†°å„¿å¯¹ä½ å¤±æœ›é€é¡¶,å¥¹æœ€ç»ˆçš„å¿ƒåŠ¨å€¼ä¸º${heartValue.toFixed(1)},ä½ ä»¬äº¤æµäº†${interactionCount}æ¬¡,å¾—åˆ†ä¸º${finalScore},å¥¹ç¦»å¼€äº†ä½ !`;
            } else if (heartValue > 100) {
                finalScore = Math.floor((heartValue * heartValue / 50) - (interactionCount ** 0.5 * 10));
                finalMessage = `æ¸¸æˆç»“æŸ,å†°å„¿å¯¹ä½ è¶…çº§æ»¡æ„!å¥¹æœ€ç»ˆçš„å¿ƒåŠ¨å€¼ä¸º${heartValue.toFixed(1)},ä½ ä»¬äº¤æµäº†${interactionCount}æ¬¡,å¾—åˆ†ä¸º${finalScore},å¥¹è¦å«ç»™ä½ !`;
            } else {
                finalScore = Math.floor((heartValue * heartValue / 50) - (interactionCount ** 0.5 * 10));
                finalMessage = `æ¸¸æˆç»“æŸ,å†°å„¿æ„çŠ¹æœªå°½!ä½ æœ€ç»ˆçš„å¾—åˆ†æ˜¯${finalScore}.`;
                if (userExited) {
                    finalMessage = `ä½ ä¸»åŠ¨é€€å‡ºäº†æ¸¸æˆã€‚${finalMessage}`;
                }
            }

            appendMessage(finalMessage);
            await saveScore(finalScore, heartValue, interactionCount); // ä¿å­˜åˆ†æ•°
        }

        /**
         * é‡ç½®æ¸¸æˆçŠ¶æ€
         */
        function resetGame() {
            heartValue = 50;
            interactionCount = 0;
            gameActive = false;
            introMessageIndex = 0; // é‡ç½®ä»‹ç»æ¶ˆæ¯ç´¢å¼•
            introMessagesCompleted = false; // é‡ç½®ä»‹ç»å®ŒæˆçŠ¶æ€
            outputDiv.innerHTML = ''; // æ¸…ç©ºè¾“å‡º
            menuDiv.innerHTML = ''; // æ¸…ç©ºæŒ‰é’®
            userInput.value = '';
            submitButton.disabled = false;
            restartButton.classList.add('hidden'); // éšè—é‡æ–°å¼€å§‹æŒ‰é’®
            updateStatus();
            // åœ¨è¿™é‡Œé‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿ä» intro å¼€å§‹
            submitButton.onclick = handleUserInputEvent; // ç»Ÿä¸€å¤„ç†è¾“å…¥
            userInput.onkeydown = (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleUserInputEvent();
                }
            };
            handleIntroContinue(); // é‡æ–°å¼€å§‹ä»‹ç»
        }


        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– Firebase å’Œæ¸¸æˆ
        window.onload = async () => {
            try {
                // åˆå§‹åŒ– Firebase åº”ç”¨
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // è®¤è¯ç”¨æˆ·
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        appendMessage(`æ¬¢è¿å›æ¥ï¼Œç”¨æˆ· ${userId.substring(0, 8)}...ï¼`);
                        updateStatus(); // ç¡®ä¿åœ¨å¼€å§‹æ¸¸æˆå‰æ›´æ–°ä¸€æ¬¡çŠ¶æ€
                        // åˆå§‹ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰è¾“å…¥ï¼ˆåŒ…æ‹¬ä»‹ç»é˜¶æ®µçš„â€œå›è½¦â€ï¼‰
                        submitButton.addEventListener('click', handleUserInputEvent);
                        userInput.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter') {
                                event.preventDefault(); // é˜»æ­¢å›è½¦é»˜è®¤è¡Œä¸º (å¦‚æäº¤è¡¨å•)
                                handleUserInputEvent();
                            }
                        });
                        restartButton.addEventListener('click', resetGame);
                        handleIntroContinue(); // å¼€å§‹æ¸¸æˆæµç¨‹
                    } else {
                        // å¦‚æœæ²¡æœ‰ tokenï¼Œå°è¯•åŒ¿åç™»å½•
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (anonError) {
                            console.error("åŒ¿åç™»å½•å¤±è´¥:", anonError);
                            appendMessage("æ— æ³•è¿›è¡ŒåŒ¿åç™»å½•ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ã€‚");
                            // å³ä½¿åŒ¿åç™»å½•å¤±è´¥ï¼Œä¹Ÿå°è¯•å¯åŠ¨æ¸¸æˆï¼Œä½†ä¿å­˜åŠŸèƒ½ä¼šå—é™
                            updateStatus();
                            // åˆå§‹ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰è¾“å…¥ï¼ˆåŒ…æ‹¬ä»‹ç»é˜¶æ®µçš„â€œå›è½¦â€ï¼‰
                            submitButton.addEventListener('click', handleUserInputEvent);
                            userInput.addEventListener('keydown', (event) => {
                                if (event.key === 'Enter') {
                                    event.preventDefault();
                                    handleUserInputEvent();
                                }
                            });
                            restartButton.addEventListener('click', resetGame);
                            handleIntroContinue();
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±è´¥:", error);
                appendMessage("æŠ±æ­‰ï¼Œæ¸¸æˆåˆå§‹åŒ–å¤±è´¥ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦æƒ…ã€‚");
                // å³ä½¿ Firebase å¤±è´¥ï¼Œä¹Ÿå…è®¸æ¸¸æˆåœ¨æ²¡æœ‰ä¿å­˜åŠŸèƒ½çš„æƒ…å†µä¸‹è¿è¡Œ
                updateStatus();
                // åˆå§‹ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰è¾“å…¥ï¼ˆåŒ…æ‹¬ä»‹ç»é˜¶æ®µçš„â€œå›è½¦â€ï¼‰
                submitButton.addEventListener('click', handleUserInputEvent);
                userInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        handleUserInputEvent();
                    }
                });
                restartButton.addEventListener('click', resetGame);
                handleIntroContinue();
            }
        };
    </script>
</body>
</html>